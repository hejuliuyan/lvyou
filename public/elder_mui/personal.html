<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>基本信息</title>
    <script src="js/mui.min.js"></script><script src="js/config.js"></script>
     <script src="js/jquery-1.7.2.min.js"></script>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <link href="css/personal.css" rel="stylesheet"/>
    <script type="text/javascript" charset="UTF-8">
      	mui.init();
    </script>
    <style>
    .mui-plus header.mui-bar {
		display: none!important;
	}
	.mui-plus .mui-bar-nav~.mui-content {
		padding: 0!important;
	}
	
	.mui-plus .plus{
		display: inline;
	}
	
	.plus{
		display: none;
	}
	
	#topPopover {
		position: fixed;
		top: 16px;
		right: 6px;
	}
	#topPopover .mui-popover-arrow {
		left: auto;
		right: 6px;
	}
	p {
		text-indent: 22px;
	}
	span.mui-icon {
		font-size: 14px;
		color: #007aff;
		margin-left: -15px;
		padding-right: 10px;
	}
	.mui-popover {
		height: 300px;
	}

    
    
    
    
    
    
	.mui-btn-block {
	    font-size: 18px;
	    display: block;
	    width: 90%;
	    margin-left: 5%;

	}
	element.style {
	    padding: 0px 0px;
	}
	.mui-content-padded {
		margin: 0;
	    margin-top: 15px;
	}
	.mui-btn-outlined.mui-btn-primary {
	    color: #FF9933;
	}
	
	.mui-btn-primary{
	    border: 1px solid #FF9933;
	}
	p {
		text-indent: 22px;
	}
	span.mui-icon {
		font-size: 14px;
		color: #007aff;
		margin-left: -15px;
		padding-right: 10px;
	}
	/*.mui-popover {
		height: 300px;
	}*/
    </style>
    
			
</head>
<body>
	<header class="mui-bar mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title">基本信息</h1>
	    <div class='mui-icon mui-icon-right-nav mui-pull-right save'><img src="wimages/personal/gou.png" width='15' heigth='15'/></div>
	</header>
	<div class="mui-content">
	    <div class='header'>
	    	<img class='headimgurl' src="wimages/personal/u222.png" width='80' height='80'/>
	    </div>
	    
        <div class="person">
        	<div class="mui-input-row us">
		       <div " class='head'><img src="wimages/personal/u286.png" width='25' height="25"/></div>
		       <div style="float:left;height:50px;line-height:50px;">用户名：</div>
		       <div style="float:left;"><input id='user' type="text" class="mui-input-clear inp" placeholder="用户名"></div>
		    </div>
        	<div class="mui-input-row us">
		       	<div class='head'><img src="wimages/personal/ushi.png" width='25' height="25"/></div>
		       	<div style="float:left;height:50px;line-height:50px;">真实姓名：</div>
		        <div style="float:left;height:50px;line-height:50px;"><input style="height:40px;line-height:40px;"id='realname'  class="inp" placeholder="请输入真实姓名(必填)"></div>
		    </div>
	    	<div class="mui-input-row us">
		       	<div class='head'><img src="wimages/personal/u296.png" width='25' height="25"/></div>
		       	<div style="float:left;height:50px;line-height:50px;">性&nbsp;&nbsp;&nbsp;&nbsp;别：</div>
		        <div style="float:left;"><select id="sex" class="mui-input-clear inp" >
		        	<option value="1">&nbsp;&nbsp;&nbsp;&nbsp;男</option>
		        	<option value="2">&nbsp;&nbsp;&nbsp;&nbsp;女</option>
		        	<option value="0">&nbsp;&nbsp;&nbsp;&nbsp;保&nbsp;密</option>
		        </select></div>
		    </div>
		    <div class="mui-input-row phone">
		       	<div class='head'><img src="wimages/personal/u300.png" width='25' height="25"/></div>
		       	<div style="float:left;height:50px;line-height:50px;">手机号：</div>
		        <div style="float:left;"><input id='phone' type="text" class="inp" placeholder="请输入手机号(必填)"></div>
		    </div>
		    <div class="mui-input-row idcard">
		       	<div class='head'><img src="wimages/personal/u298.png" width='25' height="25"/></div>
		       	<div style="float:left;height:50px;line-height:50px;">身份证号：</div>
		        <div style="float:left;"><input style="padding:0;"id='idcard' type="text" class=" inp" placeholder="请输入身份证号(必填)"></div>
		    </div>
		    
		    <!--<div class="mui-input-row pass">
		       	<div class='head'><img src="wimages/lock.png" width='25' height="25"/></div>
		        <input id='pass' type="password" disabled="disabled"  class=" inp" placeholder="******">
		    </div>-->
		    <div class="mui-input-row idcard">
			       	<div class='head'><img src="wimages/personal/u302.png" width='25' height="25"/></div>
			       	<div style="float:left;height:50px;line-height:50px;">地&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;址：</div>
			        <div style="float:left;"><input id='address' type="text" class=" inp" placeholder="请输入地址"></div>
			</div>
			<div class="mui-input-row idcard lead_phone">
			       	<div class='head'><img src="wimages/personal/uzuzhang.png" width='25' height="25"/></div>
			       	<div style="float:left;height:50px;line-height:50px;">组&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;长：</div>
			        <div style="float:left;"><input id='lead_phone' type="text" maxlength="11" onkeyup="value=this.value.replace(/\D+/g,'')"class=" inp" placeholder="请输入推荐人手机号"></div>
			</div>
	    
    	</div>
    	<div class="mui-content-padded">
    		<p>
				<a href="#middlePopover" class="mui-btn mui-btn-primary mui-btn-block mui-btn-outlined" style="padding: 5px 20px;">用户标签</a>
			</p>
    	</div>
    	
	</div>
	
	<div id="middlePopover" class="mui-popover">
		<div class="mui-popover-arrow"></div>
		<div class="mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul class="mui-table-view">
					<!--<li class="mui-table-view-cell"><a href="#">Item1</a>
					</li>-->
				</ul>
			</div>
		</div>
	</div>
	
	<script type="text/javascript">
	var userid=window.localStorage.getItem("token");
	var headimgurl=window.localStorage.getItem('headimgurl');
	//console.log(userid);
	//判断是否授权并加头像
	if (!userid) {
    	if(isWeiXin()){
    		mui.openWindow({
	            url: config[0].url+'/index.php/wx?tz=1',
	            id: 'wx'
	        })
    	}else{
    		mui.openWindow({
	            url: 'login.html',
	            id: 'login',
	            createNew:true
	        })
    	}
        
    } else {
        if (headimgurl != undefined) {
            $('.headimgurl').attr('src', headimgurl).css('border-radius', '50px');
        }
            		
   }
   $('#lead_phone').on('blur',function(){
		if($('#lead_phone').val() != ''){
			alert('注意：组长有权帮您订购，输入后风险由自己承担');
		}
	});
	
	mui.ajax(config[0].url+'/index.php/personaluser',{
	  	data:{
	  		tokenid:userid,
	  	},
		dataType:'json',//服务器返回json格式数据
		type:'post',//HTTP请求类型
		timeout:10000,//超时时间设置为10秒；
		success:function(data){
			
			console.log(data);
			$('#user').val(data[0].account);
			$('#phone').val(data[0].mobile);
			$('#realname').val(data[0].real_name);
			$('#idcard').val(data[0].id_card);
			$('#address').val(data[0].address);
			var sex = data[0].sex;
			$("select option[value="+sex+"]").attr("selected","selected");
			
			var r_name=$('#realname').val();
			var id_card=$('#idcard').val();
			var phone=$('#phone').val();
			var sex=$('#sex').val();
			if(r_name!='' && id_card!=''){
				$('#realname').attr('disabled',true);
				$('#idcard').attr('disabled',true);
			}
			if(phone!='' ){
				$('#phone').attr('disabled',true);
			}
			if(sex!='' ){
				$('#sex').attr('disabled',true);
			}
			//组长是否可用
			
			if(data[0].role == 0){
				$('#lead_phone').val('您已经是组长');
				$('#lead_phone').attr('disabled',true);
				var crew = "<div class='mui-content-padded'>"+
    						"<p>"+
								"<a href='group_crew.html' class='mui-btn mui-btn-primary mui-btn-block mui-btn-outlined' style='padding: 5px 20px;'>用户详情</a>"+
							"</p>"+
    						"</div>";
				
    			$('.mui-content').append(crew);
			}else{
				if(data[0]['leader_phone'] != '' || data[0]['leader_phone'] != null || data[0]['leader_phone'] != undefined){
					$('#lead_phone').val(data[0]['leader_phone']);
				}else{
					$('#lead_phone').val('');
				}
				
			}
			//用户标签
			console.log(data[0].member_label);
			var member_label = data[0].member_label.split(",");
			var dataIntArr=[];
			member_label.forEach(function(data,index,arr){  
		        dataIntArr.push(+data);  
		   });
		   $('.mui-popover').css('height',data['member_label'].length*45);
		   var label='';
			for(var i=0;i<data['member_label'].length;i++){
				 
				if($.inArray(data['member_label'][i]['id'],dataIntArr) == -1){
					console.log(-1);
					label += "<li class='mui-table-view-cell' id="+data['member_label'][i]['id']+"><input type='checkbox' name='member_label' value="+data['member_label'][i]['id']+">"+data['member_label'][i]['member_label']+"</li>";
				}else{
					console.log(1);
					label += "<li class='mui-table-view-cell' id="+data['member_label'][i]['id']+"><input type='checkbox' name='member_label' checked='checked' value="+data['member_label'][i]['id']+">"+data['member_label'][i]['member_label']+"</li>";
				}
				
			}
			$('.mui-table-view').append(label);
			
//			if(headimgurl != '' || headimgurl != null || headimgurl != undefined){
//				$('.headimgurl').attr('src',headimgurl).css('border-radius','40px');
//			}else{
//				$('.headimgurl').attr('src',./wimages/personal/u222.png).css('border-radius','40px');
//			}
			
		  
		},
		error:function(xhr,type,errorThrown){
		    //异常处理；
			console.log(type);
		}
	});
	
	mui.init({
		swipeBack: true //启用右滑关闭功能
	});
	mui('.mui-scroll-wrapper').scroll();
	mui('body').on('shown', '.mui-popover', function(e) {
		//console.log('shown', e.detail.id);//detail为当前popover元素
	});
	mui('body').on('hidden', '.mui-popover', function(e) {
		//console.log('hidden', e.detail.id);//detail为当前popover元素
	});
			

	$('.save').on('tap',function(){
		var user=$('#user').val();
		var name=$('#realname').val();
		var sex=$('#sex option:selected').val();
		var id_card=$('#idcard').val();
		var phone=$('#phone').val();
		var address=$('#address').val();
		var lead_phone=$('#lead_phone').val();
		
		//用户标签
		var middlePopover = document.getElementById('middlePopover');
		var checkboxArray = [].slice.call(middlePopover.querySelectorAll('input[type="checkbox"]'));
		var checkedValues = [];
		checkboxArray.forEach(function(box) {
			if (box.checked) {
				checkedValues.push(box.parentNode.id);
			}
		});	
		//console.log(checkedValues);
		
		if(username(name)==false){
			mui.toast('请输入正确的真实姓名')
		}else if(name==''){
			mui.toast('真实姓名不能为空')
		}else if(rname(name)==false){
			mui.toast('请填写真实的姓名')
		}else if(idcard==''){
			mui.toast('身份证号不能为空')
		}else if(phone==''){
			mui.toast('手机号不能为空')
		}else if(iphone(phone)==false){
			mui.toast('请填写正确的手机号')
		}else if(card(id_card)==false){
			mui.toast('请填写正确的身份证号')
		}else if(phone == lead_phone){
			mui.toast('自己不能设自己为组长');return;
		}else{
			 mui.ajax(config[0].url+'/index.php/personal',{
					  data:{
					  	userid:userid,
					  	mobile:phone,
					  	real_name:name,
					  	account:user,
					  	id_card:id_card,
					  	sex:sex,
					  	address:address,
					  	lead_phone:lead_phone,
					  	member_label:checkedValues,
					  },
					  dataType:'json',//服务器返回json格式数据
					  type:'post',//HTTP请求类型
					  timeout:10000,//超时时间设置为10秒；
					  success:function(data){//console.log(data);return;
//					    if(typeof data == "string") {var data = eval('('+data+')');}
					    /*console.log(JSON.stringify(data));*/
					   if(data=='null'){
					   		mui.toast('推荐人手机号不存在')
					   }else if(data==false){
					   		mui.toast('请修改后再进行保存或填写不正确')
					   }else if(data==true){
					   	mui.openWindow({
						    url: 'zx_personal.html', 
						    id:'zx_personal',
						    createNew:true
						});
					   }else{
						   /*for (var i in data) {
							   mui.toast(data[i][0])
						   }*/
						   mui.toast('你输入的格式不正确，请检查信息')
					   }
					  
					  },
					  error:function(xhr,type,errorThrown){
					    //异常处理；
					    //console.log(type);
						  switch (type) {
							  case "timeout":
								  mui.toast('连接超时，请重试');
								  break;
							  default:
								  mui.toast('请重试或重新登录');
						  }
				}
			});
		}
			
		
	});
	
	
	//身份证匹配
	function card(obj){   
           
        reg=/^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$|^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X|x)$/;    
        if(!reg.test(obj)){   
           return false;
        }else{   
           return true;
        }
	}
	
	//真实姓名匹配(必须是中文)
	function rname(obj){   
           
        reg=/^[\u4e00-\u9fa5]{0,4}$/;    
        if(!reg.test(obj)){   
           return false;
        }else{   
           return true;
        }
	}
	
	//账号名匹配
	function username(obj){   
           
        reg=/^[\w\u4E00-\u9FA5\uF900-\uFA2D]{1,10}$/;    
        if(!reg.test(obj)){   
           return false;
        }else{   
           return true;
        }
	}
	//手机号匹配
	function iphone(obj){   
           
        reg=/^1[3|4|5|7|8][0-9]{9}$/;
        if(!reg.test(obj)){   
           return false;
        }else{   
           return true;
        }   
    } 
</script>
</body>


</html>